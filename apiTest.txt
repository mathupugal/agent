import requests
import json
import time

def api_validator(url, method, headers=None, payload=None, expected_status=None):

    result = {
        "request": {
            "url": url,
            "method": method.lower(),
            "headers": headers if headers else {},
            "payload": payload,
            "expected_status_code": expected_status
        },
        "response": {},
        "result": ""
    }

    try:
        # start time
        start_time = time.time()

        # select method
        method = method.lower()

        if method == "get":
            response = requests.get(url, headers=headers)
        elif method == "post":
            response = requests.post(url, headers=headers, json=payload)
        elif method == "put":
            response = requests.put(url, headers=headers, json=payload)
        elif method == "patch":
            response = requests.patch(url, headers=headers, json=payload)
        elif method == "delete":
            response = requests.delete(url, headers=headers)
        else:
            result["result"] = f"fail - unsupported http method: {method}"
            return result

        # response time
        response_time = round((time.time() - start_time) * 1000, 2)

        # capture response data
        try:
            response_body = response.json()
        except ValueError:
            response_body = response.text

        result["response"] = {
            "actual_status_code": response.status_code,
            "response_body": response_body,
            "response_headers": dict(response.headers),
            "response_time_ms": response_time
        }

        # compare status
        if expected_status is not None:
            if response.status_code == expected_status:
                result["result"] = "pass"
            else:
                result["result"] = f"fail - expected {expected_status}, got {response.status_code}"
        else:
            result["result"] = "pass (no expected status provided)"

    except Exception as e:
        result["result"] = f"error - {str(e)}"

    return result


# -----------------------------
# example usage
# -----------------------------
if __name__ == "__main__":
    url = "https://jsonplaceholder.typicode.com/posts"
    method = "post"
    headers = {"content-type": "application/json"}
    payload = {"title": "foo", "body": "bar", "userId": 1}
    expected_status = 201

    output = api_validator(url, method, headers, payload, expected_status)
    print(json.dumps(output, indent=4))
